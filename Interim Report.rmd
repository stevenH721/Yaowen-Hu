---
output:
  word_document: default
  pdf_document: default
  html_document: default
---
The URL for our Team GitHub repository is https://github.com/stevenH721/Yaowen-Hu.git
The URL to the Kernel and Kaggle dataset is https://www.kaggle.com/jboysen/ny-home-mortgage
Title: Interim Report I
Author: Yaowen Hu, Qingqing Cai, Yumei Xiong, Yu Shi
---
1. What is the data problem? What is the final managerial objective?
 


# Managerial objective: The bank would like to provide loans to the applicants that are in a good financial status, thus are least likely to default.


2. Describe the measurement types of each variable
 #Based on our observation and result from str function, we conclue the measurement types as follow.
Nominal: action_taken_name; agency_abbr; agency_name; applicant_ethnicity_name; applicant_race_name_1&2&3&4&5; applicant_sex_name; co_applicant_sex_name; country_name; denial_reason_name_1&2&3; edit_status_name; hoepa_status_name; lien_status_name; loan_purpose_name; msamd_name; owner_occupancy_name; preapproval_name; property_type_name; state_abbr; respondent_id

Ordinal: as_of_year

Interval: action_taken; agency_code; applicant_ethicity; applicant_race_1&2&3&4&5; applicant_sex; applicantion_date_indicatior; census_tract_number; co_applicant_ethnicity; co_applicant_race_1&2&3&4&5; co_applicant_sex; country_code; denial_reason_1&2&3; edit_status; hoepa_status; lien_status; loan_purpose; loan_type; msamd; owner_occupancy; preapproval; property_type; purchaser_type; sequence_number; state_code

Ratio: hud_median_family_income; loan_amount_000s; number_of_1_to_4_family_units; number_of_owner_occupied_units; minority_population; population; tate_spread; tract_to_msamd_income


3. Create a table summarizing the range or variation in each variable. Add statistics (mean,
median, standard deviation, etc.) as you deem necessary.
```{r}
library(dplyr)

homeMortgage=read.csv("ny_hmda_2015.csv")
## summary table for discrete variables
hmdadisc <- homeMortgage %>%
  select(action_taken_name,agency_abbr,agency_name,applicant_ethnicity_name, applicant_race_name_1, applicant_race_name_2, applicant_race_name_3, applicant_race_name_4, applicant_race_name_5, applicant_sex_name, co_applicant_sex_name, county_name, denial_reason_name_1, denial_reason_name_2, denial_reason_name_3, edit_status_name, hoepa_status_name, lien_status_name, loan_purpose_name, msamd_name, owner_occupancy_name, preapproval_name, property_type_name, state_abbr)
summary(hmdadisc)

## summary table for continuous variables
hmdacon.df <- data.frame(matrix(NA, nrow = 43, ncol = 5))
hmdacon <- homeMortgage%>%
  select(action_taken, agency_code, applicant_ethnicity, applicant_income_000s, applicant_race_1, applicant_race_2, applicant_race_3, applicant_race_4, applicant_race_name_5, applicant_sex,application_date_indicator, as_of_year, census_tract_number, co_applicant_ethnicity, co_applicant_race_1, co_applicant_race_2, co_applicant_race_3, co_applicant_race_4, co_applicant_race_5, co_applicant_sex,county_code, denial_reason_1, denial_reason_2, denial_reason_3, edit_status, hoepa_status, lien_status, loan_amount_000s, loan_purpose,loan_type, msamd, owner_occupancy, preapproval, property_type, purchaser_type, state_code, number_of_1_to_4_family_units, number_of_owner_occupied_units, hud_median_family_income, minority_population, population, rate_spread, tract_to_msamd_income)
na.omit(hmdacon)
summary(hmdacon)

## create a table
for(n in c(1:43)){
  hmdacon.df[n,1] = mean(hmdacon[[n]], na.rm = TRUE)
}

Mode = function(x){
  ux = sort(unique(x))
  tabx= table(x)
  maxf = ux[which(tabx == max(tabx))]
  return(maxf)
}

for(n in c(1:17)){
  hmdacon.df[n,2] = Mode(hmdacon[[n]])
}

for(n in c(19:43)){
  hmdacon.df[n,2] = Mode(hmdacon[[n]])
}
## As there is a speical variable which has two mode and can't simply run with loop, we calculate it seperatly
Mode(hmdacon[[18]])
hmdacon.df[18,2] = "4,5"

for(n in c(1:43)){
  hmdacon.df[n,3] = sd(hmdacon[[n]], na.rm =  TRUE)
}

for(n in c(1:43)){
  hmdacon.df[n,4] = median(hmdacon[[n]], na.rm = TRUE)
}

for(n in c(1:43)){
  hmdacon.df[n,5] = max(hmdacon[[n]]) - min((hmdacon[[n]]))
}

names(hmdacon.df) <- c("mean","mode","standard deviation","median","range")
```


4. How do you handle missing data in this dataset?
# Firstly, we need to decide whether the missing data is missing at random. For instance, applicants with lower income may not be willing to reveal their income level. 
## If the data is missing at random, we could simply remove the missing data sample since we have huge amount of observations. There are 2 types of deletion: listwise, 
# Listwise deletion (complete-case analysis) removes all data for an observation if there is one or more missing values. For example, in this dataset, most spaces in colomn V43 in blank, so we could delete this column for simplicity. Pairwise deletion analyses all cases in which the variables of interest are present and thus maximizes all data available by an analysis basis.
# If the data is missing not at random, we could replace missing data with substituted values. For instance, one of the choices is to replace the missing data with the mean of the data we have. Using this method, we could avoid circumstances such as default listwise deletion. 
<<<<<<< HEAD
newdata<-ny_hmda_2015[which(ny_hmda_2015$V8 != "" & ny_hmda_2015$V71 != "" ),] 
omit.ny<- newdata


5. Provide histograms/density plots for key variables, such as action taken on loan, gender, ethnicity, etc.
```{r}

setwd("~/Downloads")
ny_hmda_2015=read.csv("ny_hmda_2015.csv")
homeMortgage=ny_hmda_2015[which(ny_hmda_2015[,8] != "NA" & ny_hmda_2015[,71] != "NA" ),]  
omit.ny=homeMortgage

install.packages("tidyverse")

install.packages("rpart")
install.packages("rpart.plot")
install.packages("caTools")
install.packages("caret")
install.packages("DT")

library(tidyverse)
library(rpart)
library(rpart.plot)
library(caTools)
library(caret)
library(DT)

rm(list=ls())
# Histogram for action taken on loan
homeMortgageStatus = homeMortgage %>% group_by(action_taken_name) %>%
summarise(CountOfActionTaken = n()) 
homeMortgageStatus %>%
ggplot(aes(x = action_taken_name, y = CountOfActionTaken)) +
geom_bar(stat='identity',colour="white", fill ="yellow") +
geom_text(aes(x = action_taken_name, y=1,label=paste0(CountOfActionTaken)),
            hjust=0, vjust=.5, size = 4, colour = 'black',
            fontface = 'bold') +
labs(x = 'action_taken_name', y = 'Count Of Action Taken', title = 'Histogram for action taken on loan') +
coord_flip() + 
theme_bw()
```

```{r}
# Histogram for gender
homeMortgageGender = homeMortgage %>% group_by(applicant_sex_name) %>%
summarise(CountOfActionTaken = n()) 
homeMortgageGender %>%
ggplot(aes(x = applicant_sex_name, y=CountOfActionTaken)) +
geom_bar(stat='identity',colour="white", fill ="yellow") +
geom_text(aes(y=1,label=paste0(CountOfActionTaken))) +
labs(x = 'Gender', y = 'Count Of Action Taken', title = 'Histogram for gender') +
coord_flip() + 
theme_bw()
```

```{r}
# Histogram for ethnicity
homeMortgageEthnicity = homeMortgage %>% group_by(applicant_ethnicity_name) %>%
summarise(CountOfActionTaken = n()) 
homeMortgageEthnicity %>%
ggplot(aes(x = applicant_ethnicity_name, y = CountOfActionTaken)) +
geom_bar(stat='identity',colour="white", fill ="yellow") +
geom_text(aes(x = applicant_ethnicity_name, y=100,label=paste0(CountOfActionTaken)),
            hjust=0, vjust=.5, size = 4, colour = 'black',
            fontface = 'bold') +
labs(x = 'Ethnicity', y = 'Count Of Action Taken', title = 'Histogram for ethnicity') +
coord_flip() + 
theme_bw()
```

```{r}
# Histogram for applicant's income
hist(homeMortgage$applicant_income_000s,main="Histogram of income",n=100,xlab="Applicant's income in thousands",ylab="Count",col="yellow",xlim=c(0,1500))
```


6. Create bivariate frequency distributions (tables or plots) for key variables

```{r}
# Bivariate frequency distribution for ethnicity
homeMortgageEthnicity = homeMortgage %>% 
group_by(applicant_ethnicity_name) %>%
summarise(CountOfEthnicity = n()) 

homeMortgageEthnicity2 = homeMortgage %>% 
group_by(action_taken_name,applicant_ethnicity_name) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageEthnicity3 = inner_join(homeMortgageEthnicity,homeMortgageEthnicity2) %>%
mutate(percentage = (CountOfActionTaken/CountOfEthnicity) * 100 ) 

homeMortgageEthnicity3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ applicant_ethnicity_name) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Ethnicity") +
  coord_flip() + 
  theme_bw()
```
From the graphs, we can see that applicants who are not Hispanic or Latino are more likely (60.0%) to have loan originated than those are Hispanic or Latino (49.9%). Also, applicants who are not Hispanic or Latino have a chance of 18.7% to have their application denied by financial institution, which is less than those who are Hispanic or Latino (24.8%).

```{r}
# Bivariate frequency distribution for income
homeMortgage$Income.Level="0"
homeMortgage[homeMortgage$applicant_income_000s<=50,]$Income.Level="Low Income"
homeMortgage[homeMortgage$applicant_income_000s>50 & homeMortgage$applicant_income_000s<=150,]$Income.Level="Medium Income"
homeMortgage[homeMortgage$applicant_income_000s>150,]$Income.Level="High Income"

homeMortgageIncome = homeMortgage %>% 
group_by(Income.Level) %>%
summarise(CountOfIncome = n()) 

homeMortgageIncome2 = homeMortgage %>% 
group_by(action_taken_name,Income.Level) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageIncome3 = inner_join(homeMortgageIncome,homeMortgageIncome2) %>%
mutate(percentage = (CountOfActionTaken/CountOfIncome) * 100 ) 

homeMortgageIncome3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ Income.Level) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Income") +
  coord_flip() + 
  theme_bw()
```
We divide applicants' income into three levels. Applicants whose income is lower than $50,000 are considered as low income people. Medium income applicants have income between $50,000 and $150,000, and high income applicants have income over $150,000.
From the graphs, we can see that high income applicants are most likely to have loan originated (59.5%),followed by medium income applicants (56.6%), and low income applicants are least likely to have loan originated (50.3%). When it comes to application denied by financial institution, the sequence is inverse, with probability of 14.1%, 17.9% and 29.2% for high, medium and low income applicants respectively. The reason is intuitively straightforward, that higher the income, the more guarantee of paying back loan, and the financial institution is more likely to originate loans with less worries of default.

```{r}
# Bivariate frequency distribution for race
homeMortgageRace = homeMortgage %>% 
group_by(applicant_race_name_1) %>%
summarise(CountOfRace = n()) 

homeMortgageRace2 = homeMortgage %>% 
group_by(action_taken_name,applicant_race_name_1) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageRace3 = inner_join(homeMortgageRace,homeMortgageRace2) %>%
mutate(percentage = (CountOfActionTaken/CountOfRace) * 100 ) 

homeMortgageRace3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ applicant_race_name_1) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Race") +
  coord_flip() + 
  theme_bw()
```
From the graphs, we can see that applicants who are White are most likely (61.3%) to have loan originated, while those who are American Indian or Alaska Native are least likely (41.3%). Also, applicants who White have the lowest chance of 17.8% to have their application denied by financial institution, while this percentage is 36.4% for those who are American Indian or Alaska Native.

```{r}
# Bivariate frequency distribution for gender
homeMortgageSex = homeMortgage %>% 
group_by(applicant_sex_name) %>%
summarise(CountOfSex = n()) 

homeMortgageSex2 = homeMortgage %>% 
group_by(action_taken_name,applicant_sex_name) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageSex3 = inner_join(homeMortgageSex,homeMortgageSex2) %>%
mutate(percentage = (CountOfActionTaken/CountOfSex) * 100 ) 

homeMortgageSex3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ applicant_sex_name) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Gender") +
  coord_flip() + 
  theme_bw()
```
From the graphs, we can see that gender has slight effects on actions in loans. Male applicants are slightly more likely (59.0%) to have loan originated than female applicants (58.4%). Also, male applicants are less likely to have their application denied by financial institution, with the probability of 18.8%, which is less than female applicants (20.8%).

```{r}
# Bivariate frequency distribution for hoepa status
homeMortgageHoepa = homeMortgage %>% 
group_by(hoepa_status_name) %>%
summarise(CountOfHoepa = n()) 

homeMortgageHoepa2 = homeMortgage %>% 
group_by(action_taken_name,hoepa_status_name) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageHoepa3 = inner_join(homeMortgageHoepa,homeMortgageHoepa2) %>%
mutate(percentage = (CountOfActionTaken/CountOfHoepa) * 100 ) 

homeMortgageHoepa3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ hoepa_status_name) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Hoepa Status") +
  coord_flip() + 
  theme_bw()
```
From the graphs, we can see that whether a loan is subject to HOEPA has large effects on actions in loans. All of the HOEPA loans are originated, while only 56.0% of non-HOEPA loans are originated, with 19.2% of them denied by financial insititution.

```{r}
# Bivariate frequency distribution for lien status
homeMortgageLien = homeMortgage %>% 
group_by(lien_status_name) %>%
summarise(CountOfLien = n()) 

homeMortgageLien2 = homeMortgage %>% 
group_by(action_taken_name,lien_status_name) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageLien3 = inner_join(homeMortgageLien,homeMortgageLien2) %>%
mutate(percentage = (CountOfActionTaken/CountOfLien) * 100 ) 

homeMortgageLien3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ lien_status_name) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Lien Status") +
  coord_flip() + 
  theme_bw()
```
From the graphs, we can see that loans secured by a first lien are most likely to be originated (61.9%),followed by loans secured by a subordinate lien (56.2%), and loans not secured by a lien are least likely to be originated (52.7%). When it comes to application denied by financial institution, the sequence is inverse, with probability of 19.0%, 31.5% and 41.5% for the above three types respectively. 

```{r}
# Bivariate frequency distribution for loan purpose
homeMortgageLoanPurpose = homeMortgage %>% 
group_by(loan_purpose_name) %>%
summarise(CountOfLoanPurpose = n()) 

homeMortgageLoanPurpose2 = homeMortgage %>% 
group_by(action_taken_name,loan_purpose_name) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageLoanPurpose3 = inner_join(homeMortgageLoanPurpose,homeMortgageLoanPurpose2) %>%
mutate(percentage = (CountOfActionTaken/CountOfLoanPurpose) * 100 ) 

homeMortgageLoanPurpose3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ loan_purpose_name) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Loan Purpose") +
  coord_flip() + 
  theme_bw()
```
From the graphs, we can see that loans used for home purchase are most likely to be originated (63.9%),followed by loans used for home improvement (56.2%), and loans used for refinancing are least likely to be originated (46.5%). When it comes to application denied by financial institution, loans used for home purchase are least likely to be denied (10.9%), followed by purpose of refinancing (25.2%) and home improvement (35.5%).

```{r}
# Bivariate frequency distribution for loan amount
homeMortgage$LoanAmount.Level="0"
homeMortgage[homeMortgage$loan_amount_000s<=100,]$LoanAmount.Level="Low Loan Amount"
homeMortgage[homeMortgage$loan_amount_000s>100 & homeMortgage$loan_amount_000s<=350,]$LoanAmount.Level="Medium Loan Amount"
homeMortgage[homeMortgage$loan_amount_000s>350,]$LoanAmount.Level="High Loan Amount"

homeMortgageLoanAmount = homeMortgage %>% 
group_by(LoanAmount.Level) %>%
summarise(CountOfLoanAmount = n()) 

homeMortgageLoanAmount2 = homeMortgage %>% 
group_by(action_taken_name,LoanAmount.Level) %>%
summarise(CountOfActionTaken = n()) 

homeMortgageLoanAmount3 = inner_join(homeMortgageLoanAmount,homeMortgageLoanAmount2) %>%
mutate(percentage = (CountOfActionTaken/CountOfLoanAmount) * 100 ) 

homeMortgageLoanAmount3 %>%
  ggplot(aes(x = action_taken_name, y = percentage)) +
  facet_wrap(~ LoanAmount.Level) +
  geom_bar(stat="identity",fill="lightblue") +
  geom_text(aes(x = action_taken_name, y = 1, label = ifelse(floor(round(percentage,1))==round(percentage,1),paste0(round(percentage,1),".0%"),paste0(round(percentage,1),"%"))),
            hjust=0,size = 4.5, colour = "black") +
  labs(x = "action_taken_name", y = "Percentage Count Of Action Taken", title = "Actions in Loans by Loan Amount") +
  coord_flip() + 
  theme_bw()
```
We divide loan amount into three levels. Loan amount which is lower than $100,000 are considered as low loan amount. Medium loan amount has a range between $100,000 and $350,000, and high loan amount is over $350,000.
From the graphs, we can see that medium amount loans are most likely to be originated (56.4%),followed by low amount loans (56.1%), and high amount loans are least likely to be originated (55.4%). When it comes to application denied by financial institution, the probability of being denied is 16.8%, 26.9% and 16.0% for the three types of loans respectively. The results are counterintuitive, and the reason may be that the loan amount that people apply for is correlated with other variables, such as loan purpose and applicant's income. the graphs here only reflect the relationship between actions in loan and loan amount, without taking into control other variables. 
